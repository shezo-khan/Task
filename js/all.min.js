
lscache.flush();

$(document).on("click", '.productlist__Itembutton', function()
{
	var cartItemsAdded = $('.cart-nav__list').html(),
		productName  = $(this).parents('li').attr('data-name'),
		productPrice = $(this).parents('li').attr('data-price'),
		productId    = $(this).parents('li').attr('data-id'),
		productIdCounter = lscache.get( productId );

	if( productIdCounter == null )
	{
		productIdCounter = 0;	
		productIdCounter = productIdCounter + 1;
		newItem = '<li class="cart-nav__item" data-id="'+ productId +'"><span class="cd-qty cart-nav__item--quantity"></span> '+ productName +'<div class="cd-price cart-nav__price cart-nav__price--text-color">NOK '+ productPrice +'</div><div class="quantity"><label for="cd-product-2">Qty</label><span class="select"><select id="cd-product-2" class="select2" name="quantity"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select></span></div><a href="#" class="cart-nav__remove cd-img-replace">Remove</a></li>';
		$('.cart-nav__list').html( newItem + cartItemsAdded );
		lscache.set( productId, productIdCounter );
	}
	else
	{
		productIdCounter = productIdCounter + 1;
		lscache.set( productId, productIdCounter );
		$('.cart-nav__list').html( cartItemsAdded );
		$('.cart-nav__list').find("li  [data-id=' " + productId + "']").find('span.cart-nav__item--quantity').html( productIdCounter + 'x' );
	}
	
	reTotal();
	swal(productName, "Added to Cart", "success");
	return;
	
	
});

$(document).on("click", '.cart-nav__remove', function()
{
	productId = $(this).parents('li').attr('data-id');
	swal({
	title: "Are you sure?",
	text: "The product will be deleted from cart",
	type: "warning",
	showCancelButton: true,
	confirmButtonColor: "#DD6B55",
	confirmButtonText: "Yes, delete it!",
	cancelButtonText: "No",
	closeOnConfirm: false,
	closeOnCancel: false
	},
	function(isConfirm){
	if (isConfirm) {
		console.log( productId );
		$('.cart-nav__list').find("li[data-id='"+ productId +"']").remove();
		lscache.set( productId, null );
		reTotal();
		swal("Deleted!", "Product is deleted from Cart", "success");
	} else {
		swal("Cancelled", "", "error");
		return;
	}
	});

});

$(document).on('change','.select2',function(){
	reTotal();
});

function reTotal()
{
	var totalPrice = 0;
	$('.cart-nav__list').find('.cart-nav__item').each(function(index, element) 
	{

		 var countProduct = $(this).find('.select option:selected').html();
		 var price = $(this).find('.cart-nav__price').html();
		 price = price.replace(/[NOK,]+/g,"");
		 price = parseFloat( price ); 

		 var priceOfProduct = price * countProduct;
		 totalPrice = totalPrice + priceOfProduct;
		 
    });
	$('.js_total_cart_amount').html( totalPrice );
	$('.js_total_no_products').html( $('.cart-nav__item').length  );
}


jQuery(document).ready(function($){

	var $L = 1200,
		$left_navigation = $('.main-navigation__menu'),
		$cart_button = $('.shopping-cart'),
		$left_menu_icon = $('.main-navigation__hamburger'),
		$cart_menu = $('.cart-nav'),
		$shadow_layer = $('#cd-shadow-layer');

	//open Main menu on mobile
	$left_menu_icon.on('click', function(event){
		event.preventDefault();
		//close cart panel (if it's open)
		$cart_menu.removeClass('speed-in');
		toggle_panel_visibility($left_navigation, $shadow_layer, $('body'));
	});

	//open cart
	$cart_button.on('click', function(event){
		event.preventDefault();
		//close lateral menu (if it's open)
		$left_navigation.removeClass('speed-in');
		toggle_panel_visibility($cart_menu, $shadow_layer, $('body'));
	});

	//close  cart or  menu by clicking shadow layer
	$shadow_layer.on('click', function(){
		$shadow_layer.removeClass('is-visible');
		// firefox transitions break when parent overflow is changed, so we need to wait for the end of the trasition to give the body an overflow hidden
		if( $cart_menu.hasClass('speed-in') ) {
			$cart_menu.removeClass('speed-in').on('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(){
				$('body').removeClass('overflow-hidden');
			});
			$left_navigation.removeClass('speed-in');
		} else {
			$left_navigation.removeClass('speed-in').on('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(){
				$('body').removeClass('overflow-hidden');
			});
			$cart_menu.removeClass('speed-in');
		}
	});

	//move #main-navigation inside header on laptop
	//insert #main-navigation after header on mobile
	move_navigation( $left_navigation, $L);

	$(window).on('resize', function(){
		move_navigation( $left_navigation, $L);
		
		if( $(window).width() >= $L && $left_navigation.hasClass('speed-in')) {
			$left_navigation.removeClass('speed-in');
			$shadow_layer.removeClass('is-visible');
			$('body').removeClass('overflow-hidden');
		}

	});
});

function toggle_panel_visibility ($lateral_panel, $background_layer, $body) {
	if( $lateral_panel.hasClass('speed-in') ) {
		// firefox transitions break when parent overflow is changed, so we need to wait for the end of the trasition to give the body an overflow hidden
		$lateral_panel.removeClass('speed-in').on('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(){
			$body.removeClass('overflow-hidden');
		});
		$background_layer.removeClass('is-visible');

	} else {
		$lateral_panel.addClass('speed-in').on('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function(){
			$body.addClass('overflow-hidden');
		});
		$background_layer.addClass('is-visible');
	}
}

function move_navigation( $navigation, $MQ) {
	if ( $(window).width() >= $MQ ) {
		$navigation.detach();
		$navigation.appendTo('header');
	} else {
		$navigation.detach();
		$navigation.insertAfter('header');
	}
}